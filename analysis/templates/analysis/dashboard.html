<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap');
        .scrollbar-thin::-webkit-scrollbar { width: 4px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #e5e7eb; border-radius: 2px; }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { dark: '#1A1A1A' },
                    fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] }
                }
            }
        }
    </script>
</head>
<body class="min-h-screen bg-white font-sans">
    {% include "includes/header.html" %}

    <div x-data="analysisApp()" x-init="init()" class="p-8">
        <div class="max-w-4xl mx-auto">
            <h1 class="text-2xl font-medium text-gray-900 mb-2">Correlation Analysis</h1>
            <p class="text-gray-500 mb-6">Understand what drives outcomes across questions</p>

            <!-- Loading Questions -->
            <div x-show="loadingQuestions" class="text-center py-12 text-gray-400">
                Loading questions...
            </div>

            <div x-show="!loadingQuestions">
                <!-- Controls -->
                <div class="bg-gray-50 rounded-lg p-4 mb-6 space-y-4">
                    <!-- Target Question -->
                    <div class="flex items-center gap-4">
                        <label class="text-sm font-medium text-gray-700 w-32">Explain:</label>
                        <select
                            x-model="targetQuestionId"
                            @change="onTargetChange()"
                            class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-gray-300"
                        >
                            <option value="">Select a question...</option>
                            <template x-for="q in questions" :key="q.id">
                                <option :value="q.id" x-text="q.text.substring(0, 60) + (q.text.length > 60 ? '...' : '')"></option>
                            </template>
                        </select>
                    </div>

                    <!-- Target Theme (only for theme-based targets) -->
                    <div x-show="targetQuestion && !targetQuestion.has_sentiment" class="flex items-center gap-4">
                        <label class="text-sm font-medium text-gray-700 w-32">Focus on theme:</label>
                        <select
                            x-model="targetTheme"
                            @change="loadCorrelations()"
                            class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-gray-300"
                        >
                            <option value="">Select a theme...</option>
                            <template x-for="theme in targetQuestion?.themes || []" :key="theme">
                                <option :value="theme" x-text="theme"></option>
                            </template>
                        </select>
                    </div>

                    <!-- Source Questions -->
                    <div class="flex items-center gap-4">
                        <label class="text-sm font-medium text-gray-700 w-32">Using themes from:</label>
                        <select
                            x-model="sourceQuestionId"
                            @change="loadCorrelations()"
                            class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-gray-300"
                        >
                            <option value="">Select a question...</option>
                            <template x-for="q in sourceQuestions" :key="q.id">
                                <option :value="q.id" x-text="q.text.substring(0, 60) + (q.text.length > 60 ? '...' : '')"></option>
                            </template>
                        </select>
                    </div>
                </div>

                <!-- Loading Correlations -->
                <div x-show="loadingCorrelations" class="text-center py-12 text-gray-400">
                    Calculating correlations...
                </div>

                <!-- No Data State -->
                <div x-show="!loadingCorrelations && (!targetQuestionId || !sourceQuestionId)" class="text-center py-12 text-gray-400">
                    Select questions to analyze.
                </div>

                <div x-show="!loadingCorrelations && targetQuestionId && sourceQuestionId && themes.length === 0 && !needsThemeSelection" class="text-center py-12 text-gray-400">
                    <p>Not enough data for correlation analysis.</p>
                    <p class="text-sm mt-2">Requires respondent tracking across multiple questions.</p>
                </div>

                <div x-show="!loadingCorrelations && needsThemeSelection" class="text-center py-12 text-gray-400">
                    Select a theme to explain.
                </div>

                <!-- Results -->
                <div x-show="!loadingCorrelations && themes.length > 0">
                    <p class="text-sm text-gray-500 mb-4">
                        Based on <span class="font-medium" x-text="respondentCount"></span> respondents.
                        <span x-show="analysisType === 'sentiment'">Analyzing sentiment correlation.</span>
                        <span x-show="analysisType === 'theme'">
                            Analyzing co-occurrence with "<span class="font-medium" x-text="targetTheme"></span>"
                            (<span x-text="targetThemeCount"></span> respondents).
                        </span>
                    </p>

                    <!-- Chart -->
                    <div class="mb-6" :style="'height: ' + Math.max(250, themes.length * 28) + 'px'">
                        <canvas id="correlation-chart"></canvas>
                    </div>

                    <!-- Legend -->
                    <div class="flex justify-center gap-8 mb-8 text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-4 h-4 rounded" style="background: rgba(239, 68, 68, 0.8)"></div>
                            <span class="text-gray-600" x-text="analysisType === 'sentiment' ? 'Associated with feeling bad' : 'Negative correlation'"></span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-4 h-4 rounded" style="background: rgba(34, 197, 94, 0.8)"></div>
                            <span class="text-gray-600" x-text="analysisType === 'sentiment' ? 'Associated with feeling good' : 'Positive correlation'"></span>
                        </div>
                    </div>

                    <!-- Insights -->
                    <div class="grid md:grid-cols-2 gap-6">
                        <!-- Positive -->
                        <div class="border border-green-200 bg-green-50 rounded-lg p-5">
                            <h3 class="font-medium text-green-900 mb-3" x-text="analysisType === 'sentiment' ? 'Drivers of Positive Mood' : 'Positively Correlated'"></h3>
                            <div class="space-y-2">
                                <template x-for="theme in positiveThemes.slice(0, 5)" :key="theme.name">
                                    <div class="text-sm">
                                        <span class="font-medium text-green-800" x-text="theme.name"></span>
                                        <template x-if="analysisType === 'sentiment'">
                                            <span class="text-green-600 text-xs ml-1">
                                                (avg <span x-text="theme.mean_with"></span> vs <span x-text="theme.mean_without"></span>)
                                            </span>
                                        </template>
                                        <template x-if="analysisType === 'theme'">
                                            <span class="text-green-600 text-xs ml-1">
                                                (<span x-text="theme.lift"></span>x more likely)
                                            </span>
                                        </template>
                                    </div>
                                </template>
                                <p x-show="positiveThemes.length === 0" class="text-sm text-green-600">No strong positive correlations.</p>
                            </div>
                        </div>

                        <!-- Negative -->
                        <div class="border border-red-200 bg-red-50 rounded-lg p-5">
                            <h3 class="font-medium text-red-900 mb-3" x-text="analysisType === 'sentiment' ? 'Drivers of Negative Mood' : 'Negatively Correlated'"></h3>
                            <div class="space-y-2">
                                <template x-for="theme in negativeThemes.slice(0, 5)" :key="theme.name">
                                    <div class="text-sm">
                                        <span class="font-medium text-red-800" x-text="theme.name"></span>
                                        <template x-if="analysisType === 'sentiment'">
                                            <span class="text-red-600 text-xs ml-1">
                                                (avg <span x-text="theme.mean_with"></span> vs <span x-text="theme.mean_without"></span>)
                                            </span>
                                        </template>
                                        <template x-if="analysisType === 'theme'">
                                            <span class="text-red-600 text-xs ml-1">
                                                (<span x-text="theme.lift"></span>x likely)
                                            </span>
                                        </template>
                                    </div>
                                </template>
                                <p x-show="negativeThemes.length === 0" class="text-sm text-red-600">No strong negative correlations.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Method Note -->
                    <p class="text-xs text-gray-400 mt-8 text-center">
                        <span x-show="analysisType === 'sentiment'">Point-biserial correlation between theme presence and sentiment score.</span>
                        <span x-show="analysisType === 'theme'">Phi coefficient between theme co-occurrence. Lift = how many times more likely.</span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        function analysisApp() {
            return {
                loadingQuestions: true,
                loadingCorrelations: false,
                questions: [],
                targetQuestionId: '',
                targetTheme: '',
                sourceQuestionId: '',
                themes: [],
                respondentCount: 0,
                targetThemeCount: 0,
                analysisType: 'sentiment',
                chart: null,

                get targetQuestion() {
                    return this.questions.find(q => q.id == this.targetQuestionId);
                },

                get sourceQuestions() {
                    return this.questions.filter(q => q.id != this.targetQuestionId && q.has_themes);
                },

                get needsThemeSelection() {
                    return this.targetQuestion && !this.targetQuestion.has_sentiment && !this.targetTheme;
                },

                get positiveThemes() {
                    return this.themes.filter(t => t.correlation > 0.05).sort((a, b) => b.correlation - a.correlation);
                },

                get negativeThemes() {
                    return this.themes.filter(t => t.correlation < -0.05).sort((a, b) => a.correlation - b.correlation);
                },

                async init() {
                    await this.loadQuestions();

                    // Auto-select first question with sentiment as target
                    const sentimentQ = this.questions.find(q => q.has_sentiment);
                    if (sentimentQ) {
                        this.targetQuestionId = sentimentQ.id;
                        // Auto-select first source question
                        const firstSource = this.questions.find(q => q.id !== sentimentQ.id && q.has_themes);
                        if (firstSource) {
                            this.sourceQuestionId = firstSource.id;
                            await this.loadCorrelations();
                        }
                    }
                },

                async loadQuestions() {
                    this.loadingQuestions = true;
                    try {
                        const response = await fetch('/analysis/api/questions/');
                        const data = await response.json();
                        this.questions = data.questions || [];
                    } catch (error) {
                        console.error('Failed to load questions:', error);
                    } finally {
                        this.loadingQuestions = false;
                    }
                },

                onTargetChange() {
                    this.targetTheme = '';
                    this.themes = [];
                    // Reset source if it's now the same as target
                    if (this.sourceQuestionId == this.targetQuestionId) {
                        this.sourceQuestionId = '';
                    }
                    if (this.targetQuestion?.has_sentiment && this.sourceQuestionId) {
                        this.loadCorrelations();
                    }
                },

                async loadCorrelations() {
                    if (!this.targetQuestionId) return;
                    if (!this.sourceQuestionId) return;
                    if (!this.targetQuestion.has_sentiment && !this.targetTheme) return;

                    this.loadingCorrelations = true;
                    try {
                        let url = `/analysis/api/correlations/?target=${this.targetQuestionId}&sources=${this.sourceQuestionId}`;
                        if (this.targetTheme) {
                            url += `&target_theme=${encodeURIComponent(this.targetTheme)}`;
                        }

                        const response = await fetch(url);
                        const data = await response.json();

                        this.themes = data.themes || [];
                        this.respondentCount = data.respondent_count || 0;
                        this.targetThemeCount = data.target_theme_count || 0;
                        this.analysisType = data.analysis_type || 'sentiment';

                        this.$nextTick(() => this.renderChart());
                    } catch (error) {
                        console.error('Failed to load correlations:', error);
                    } finally {
                        this.loadingCorrelations = false;
                    }
                },

                renderChart() {
                    if (this.chart) {
                        this.chart.destroy();
                    }

                    if (this.themes.length === 0) return;

                    const canvas = document.getElementById('correlation-chart');
                    if (!canvas) return;

                    const sorted = [...this.themes].sort((a, b) => b.correlation - a.correlation);
                    const labels = sorted.map(t => t.name);
                    const data = sorted.map(t => t.correlation);
                    const colors = data.map(v => v >= 0 ? 'rgba(34, 197, 94, 0.8)' : 'rgba(239, 68, 68, 0.8)');

                    // Determine axis range
                    const maxAbs = Math.max(Math.abs(Math.min(...data)), Math.abs(Math.max(...data)), 0.3);
                    const axisLimit = Math.ceil(maxAbs * 10) / 10;

                    this.chart = new Chart(canvas, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                data: data,
                                backgroundColor: colors,
                                borderWidth: 0,
                            }]
                        },
                        options: {
                            indexAxis: 'y',
                            responsive: true,
                            maintainAspectRatio: false,
                            animation: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: (ctx) => {
                                            const theme = sorted[ctx.dataIndex];
                                            if (this.analysisType === 'sentiment') {
                                                return [
                                                    `Correlation: ${theme.correlation}`,
                                                    `Avg with theme: ${theme.mean_with}`,
                                                    `Avg without: ${theme.mean_without}`,
                                                    `Respondents: ${theme.count}`
                                                ];
                                            } else {
                                                return [
                                                    `Phi: ${theme.correlation}`,
                                                    `Lift: ${theme.lift}x`,
                                                    `Co-occurrences: ${theme.co_occurrence}`,
                                                    `Respondents with theme: ${theme.count}`
                                                ];
                                            }
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    min: -axisLimit,
                                    max: axisLimit,
                                    grid: { color: '#f3f4f6' },
                                    ticks: {
                                        callback: (v) => v.toFixed(1)
                                    }
                                },
                                y: {
                                    grid: { display: false },
                                    ticks: { font: { size: 11 }, color: '#374151' }
                                }
                            }
                        }
                    });
                }
            };
        }
    </script>
</body>
</html>
